<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מחולל צירופי לוטו מתקדם</title>
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=pub-2154227955978159"
         crossorigin="anonymous"></script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

	

    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .counters {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            text-align: center;
        }

        .counter {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .counter-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .counter-label {
            color: #4a5568;
            font-size: 0.9em;
        }

        .file-upload {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .file-upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
        }

        .file-upload-area:hover {
            border-color: #f5576c;
            background: #fafafa;
        }

        .file-input {
            display: none;
        }

        .file-upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .file-upload-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        #download-sample-btn {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            font-weight: bold;
        }

        #download-sample-btn:hover {
            background: linear-gradient(135deg, #00a085 0%, #008f7a 100%);
        }

        .file-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        .file-status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .file-status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .history-filter {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .history-filter label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .history-filter input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        label {
            font-weight: bold;
            color: #2d3748;
        }
        
        select, input {
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            transition: all 0.3s ease;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }
        
        .results {
            margin-top: 30px;
        }
        
        .combination {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            margin: 15px 0;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .combination.winner {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            border: 3px solid #e17055;
        }

        .combination.new {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }
        
        .numbers {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .number {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .regular {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .strong {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .stats {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stats-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #2d3748;
            font-size: 1.2em;
        }
        
        .hot-numbers {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .hot-category {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .hot-category h4 {
            margin: 0 0 10px 0;
            color: #4a5568;
        }
        
        .hot-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .hot-number {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
        }

        .winner-badge {
            background: #e17055;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }

        .new-badge {
            background: #00b894;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        /* CSS לאנימציות פרסומות */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes slideIn {
            from { 
                transform: scale(0.7) translateY(-50px);
                opacity: 0;
            }
            to { 
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .combination {
                flex-direction: column;
                text-align: center;
            }

            .counters {
                grid-template-columns: 1fr;
            }

            .history-filter {
                flex-direction: column;
                align-items: stretch;
            }
        }

#sidebar {
  position: fixed;
  top: 0;
  right: -500px; /* מוסתר מחוץ למסך */
  width: 400px;
  height: 100%;
  background: #fff;
  border-left: 2px solid #ccc;
  box-shadow: -2px 0 5px rgba(0,0,0,0.2);
  transition: right 0.3s ease;
  overflow-y: auto;
  z-index: 9999;
  padding: 15px;
}
#sidebar.open {
  right: 0; /* נכנס למסך */
}
.sidebar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #ddd;
  margin-bottom: 10px;
}

    </style>
<script type="module">
    // --- ייבוא ספריות ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getDatabase, ref, runTransaction, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    // --- קונפיגורציה ---
    const firebaseConfig = {
        apiKey: "AIzaSyDewHgup8jkCbRJOKfcE8qJn96lO5ZPo_I",
        authDomain: "loto-hot.firebaseapp.com",
        databaseURL: "https://loto-hot-default-rtdb.firebaseio.com",
        projectId: "loto-hot",
        storageBucket: "loto-hot.firebasestorage.app",
        messagingSenderId: "1078323335501",
        appId: "1:1078323335501:web:77f214ff257f14d17d2704",
        measurementId: "G-FR83RCV8Z8"
    };

    // --- אתחול Firebase ---
    const app = initializeApp(firebaseConfig);

    // --- אתחול Realtime Database ---
    const database = getDatabase(app);

    // --- אתחול Firestore ---
    const db = getFirestore(app);

    console.log("✅ Firebase initialized");
    console.log("✅ Realtime Database ready:", database);
    console.log("✅ Firestore ready:", db);

    // --- דוגמת שימוש ---
    // שמירה ל-Firestore
    async function saveCombinationToFirestore(combination) {
        try {
            const docRef = await addDoc(collection(db, "combinations"), {
                combination,
                createdAt: new Date().toISOString(),
                hits: 0,
                hasStrong: false,
                expireAt: null
            });
            console.log("✅ Saved combination with ID:", docRef.id);
        } catch (error) {
            console.error("❌ Firestore save error:", error);
        }
    }

    // דוגמת שימוש ל-Realtime Database
    function incrementCounter(counterPath) {
        const counterRef = ref(database, counterPath);
        runTransaction(counterRef, current => (current || 0) + 1);
    }






    // משתנים גלובליים
    let visitCount = 0;
    let comboCount = 0;
    let lotteryHistory = [];

    // מאזין בזמן אמת לנתונים מהפיירבייס
    function listenToCounters() {
        const countersRef = ref(database, 'counters');
        onValue(countersRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                visitCount = data.visits || 0;
                comboCount = data.combos || 0;
                updateCountersDisplay()
            }
        });
    }

    // מגדיל את מונה הביקורים
    function incrementVisitInFirebase() {
        runTransaction(ref(database, 'counters/visits'), (current) => (current || 0) + 1)
            .catch((error) => console.error("❌ visit increment error:", error));
    }

    // מגדיל את מונה הצירופים
    function incrementComboInFirebase() {
        runTransaction(ref(database, 'counters/combos'), (current) => (current || 0) + 1)
            .catch((error) => console.error("❌ combo increment error:", error));
    }

    // מגדיל צירופים בכמות מסוימת
    function incrementCombosInFirebase(count) {
        runTransaction(ref(database, 'counters/combos'), (current) => (current || 0) + count)
            .catch((error) => console.error("❌ combo increment error:", error));
         return;
    }

    // עדכון התצוגה באתר
    function updateCountersDisplay() {
        document.getElementById("visitCount").textContent = visitCount;
        document.getElementById("comboCount").textContent = comboCount;
    }

    // טעינת האתר
    window.addEventListener("DOMContentLoaded", () => {
        listenToCounters();      // מאזין למונים בזמן אמת
        incrementVisitInFirebase(); // סופר כניסה חדשה
    });
     window.incrementCombosInFirebase = incrementCombosInFirebase;
</script>




	

</head>
<body>
    <div class="container">
        <h1>🎲 מחולל צירופי לוטו מתקדם 🎲</h1>
        
        <!-- מונים -->
        <div class="counters">
            <div class="counter">
                <div class="counter-number" id="visitCount">0</div>
                <div class="counter-label">ביקורים באתר</div>
            </div>
            <div class="counter">
                <div class="counter-number" id="comboCount">0</div>
                <div class="counter-label">צירופים שנוצרו</div>
            </div>
            <div class="counter">
                <div class="counter-number" id="history-counter">0</div>
                <div class="counter-label">הגרלות בהיסטוריה</div>
            </div>
        </div>

<!-- כפתור פתיחה -->
<button class="open-sidebar" onclick="toggleSidebar()">📂 היסטוריית פגיעות</button>

<!-- חלון צד -->
<div id="sidebar">
  <div class="sidebar-header">
    <h2>📊 היסטוריית פגיעות</h2>
    <button onclick="toggleSidebar()">❌ סגור</button>
  </div>
  <div id="sidebar-content"></div>
</div>

    >
<button class="file-upload-btn" onclick="toggleUploadSection()">📂 הצג / הסתר אפשרות העלאת קובץ</button>

<!-- אזור ההעלאה (סגור כברירת מחדל) -->
<div id="upload-section" style="display: none; margin-top: 15px;">

    <div class="stats-title">📊 העלאת קובץ תוצאות הגרלות</div>
    
    <!-- כפתור הורדה -->
    <div style="text-align: center; margin-bottom: 20px;">
        <a href="#" id="download-sample-btn" class="file-upload-btn" onclick="downloadSampleFile()" style="text-decoration: none; display: inline-block;">
          הורדת קובץ עם תוצאות ההגרלות מתאריך 28/02/2009
        </a>
        <div style="font-size: 12px; color: #666; margin-top: 5px;">
            קובץ Excel מעודכן עם כל תוצאות הלוטו מהשנים האחרונות נטען אוטומטית בכניסה לאתר.<br>
            במידה ויש בידכם קובץ אחר שתרצו להפיק ממנו צירופים ניתן לטעון אותו כאן על פי הפרמטרים הרשומים מטה.
        </div>
    </div>
    
    <!-- אזור העלאה -->
    <div class="file-upload-area" onclick="document.getElementById('excel-file').click()">
        <div>📁 לחץ כאן להעלאת קובץ Excel עם תוצאות הגרלות קודמות</div>
        <button type="button" class="file-upload-btn">בחר קובץ מהמחשב</button>
        <div style="font-size: 12px; color: #666; margin-top: 10px;">
            קובץ Excel צריך לכלול עמודות: תאריך, מספר1, מספר2, מספר3, מספר4, מספר5, מספר6, מספר_חזק
        </div>
    </div>
    <input type="file" id="excel-file" class="file-input" accept=".xlsx,.xls" onchange="handleExcelUpload(event)">
    <div id="file-status" class="file-status"></div>
</div>


        <!-- מסנן היסטוריה -->
        <div class="history-filter" id="history-filter" style="display: none;">
            <div class="stats-title">🎯 בחירת סוג צירופים:</div>
            <label>
                <input type="checkbox" id="allow-winners" checked>
                אפשר צירופים שזכו בעבר
            </label>
            <label>
                <input type="checkbox" id="allow-new" checked>
                אפשר צירופים חדשים
             </label>
             <label>
                <input type="checkbox" 
id="no-two-sequences"> בלי רצפים של 2 מספרים עוקבים (צימצום של 61% מהאפשרויות)
            </label>
            <label>
  <input type="checkbox"
id="no-sequences"> בלי רצפים של 3 מספרים עוקבים ומעלה (צימצום 8.2% אחוז מכלל האפשרויות)       </label>
        </div>
        
        <div class="stats">
            <div class="stats-title">📊 המספרים החמים ביותר (על פי הסטטיסטיקות - משנת 2005 מאתר מפעל הפיס)</div>
            <div class="hot-numbers">
                <div class="hot-category">
                    <h4>מספרים ראשיים חמים:</h4>
                    <div class="hot-list" id="hot-regular-list">
                        </div>
                </div>
                <div class="hot-category">
                    <h4>מספר חזק חם:</h4>
                    <div class="hot-list" id="hot-strong-list">
                        </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="strategy">אסטרטגיה:</label>
                <select id="strategy">
                    <option value="hot">מספרים חמים (הופיעו הרבה)</option>
                    <option value="balanced">מאוזן (חמים + קרים)</option>
                    <option value="cold">מספרים קרים (הופיעו מעט)</option>
                    <option value="random">אקראי לחלוטין</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="combinations">מספר צירופים:</label>
                <select id="combinations">
                    <option value="2" selected>2</option>
                    <option value="4">4</option>
                    <option value="6">6</option>
                    <option value="8">8</option>
                    <option value="10">10<option>
                    <option value="12">12<option>
                    <option value="14">14<option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="hotWeight">משקל מספרים חמים:</label>
                <input type="range" id="hotWeight" min="0" max="100" value="70">
                <span id="hotWeightValue">70%</span>
            </div>
        </div>
        
        <div style="text-align: center;">
            <button class="generate-btn" onclick="generateNumbers()">🎯 צור צירופים</button>
        </div>
        
        <div id="results" class="results"></div>
    </div>





<script>




		
        // משתנים גלובליים
        let visitCount = 0;
        let comboCount = 0;
        let lotteryHistory = [];
        let winningCombinations = new Set();

        // פונקציה לטעינת נתונים מהזיכרון
        function loadCounters() {
  			  const db = firebase.database();

    		db.ref("counters/visitCount").on("value", (snapshot) => {
        		document.getElementById("visitCount").innerText = snapshot.val() || 0;
   			 });

    		db.ref("counters/comboCount").on("value", (snapshot) => {
        		document.getElementById("comboCount").innerText = snapshot.val() || 0;
    		});

            
            // בניית רשימת צירופים זוכים
            //buildWinningCombinations();
           
           // updateCountersDisplay();
        }

        // פונקציה לשמירת נתונים לזיכרון
        function saveCounters() {
            sessionStorage.setItem('lotto-visits', JSON.stringify(visitCount));
            sessionStorage.setItem('lotto-combos', JSON.stringify(comboCount));
            sessionStorage.setItem('lotto-history', JSON.stringify(lotteryHistory));
        }

        // פונקציה לעדכון תצוגת המונים
        function updateCountersDisplay() {
            document.getElementById('visitCount').textContent = visitCount.toLocaleString('he-IL');
            document.getElementById('comboCount').textContent = comboCount.toLocaleString('he-IL');
            document.getElementById('history-counter').textContent = lotteryHistory.length.toLocaleString('he-IL');
        }

        // פונקציה לבניית רשימת צירופים זוכים
        function buildWinningCombinations() {
            winningCombinations.clear();
            lotteryHistory.forEach(draw => {
                if (draw.numbers && draw.strong) {
                    const combination = [...draw.numbers].sort((a, b) => a - b).join(',') + '|' + draw.strong;
                    winningCombinations.add(combination);
                }
            });
        }

        // פונקציה לבדיקה אם צירוף זכה בעבר
        function isCombinationWinner(regularNumbers, strongNumber) {
            const combination = [...regularNumbers].sort((a, b) => a - b).join(',') + '|' + strongNumber;
            return winningCombinations.has(combination);
        }

        // פונקציה להורדת קובץ הדוגמה
        function downloadSampleFile() {
            // כאן תוכל להחליף את הקישור לקישור האמיתי שלך ב-GitHub
            const githubUrl = 'https://github.com/eliranneeman/loto_hot_number/raw/refs/heads/main/Lotto.xlsx';
            
            // יצירת אלמנט a זמני להורדה
            const link = document.createElement('a');
            link.href = githubUrl;
            link.download = 'lottery_results.xlsx';
            link.target = '_blank';
            
            // הצגת הודעה למשתמש
            const status = document.getElementById('file-status');
            status.style.display = 'block';
            status.className = 'file-status';
            status.innerHTML = '🔄 מפנה להורדת הקובץ מ-GitHub...';
            
            // ניסיון לפתוח את הקישור
            try {
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => {
                    status.className = 'file-status success';
                    status.innerHTML = '✅ הקישור נפתח! אם ההורדה לא החלה, נסה שוב או פנה ישירות לקישור GitHub.';
                }, 1000);
                
            } catch (error) {
                status.className = 'file-status error';
                status.innerHTML = `❌ שגיאה בפתיחת הקישור. נסה לגשת ישירות: <a href="${githubUrl}" target="_blank" style="color: #721c24;">לחץ כאן</a>`;
            }
        }

        // פונקציה לטיפול בהעלאת קובץ Excel
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            const status = document.getElementById('file-status');
            
            if (!file) return;
            
            status.style.display = 'block';
            status.className = 'file-status';
            status.textContent = 'טוען קובץ...';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    processLotteryData(jsonData);
                    
                    status.className = 'file-status success';
                    status.textContent = `✅ הקובץ נטען בהצלחה! נטענו ${lotteryHistory.length} הגרלות`;
                    
                     // הוסף את השורה הזו:
                    document.getElementById('history-counter').textContent = lotteryHistory.length;
            
                     
                    document.getElementById('history-filter').style.display = 'flex';
                    
                } catch (error) {
                    status.className = 'file-status error';
                    status.textContent = '❌ שגיאה בטעינת הקובץ. אנא וודא שהקובץ בפורמט הנכון';
                    console.error('Error processing Excel file:', error);
                }
            };
            
            reader.readAsBinaryString(file);
        }

        // פונקציה לעיבוד נתוני ההגרלות
        function processLotteryData(data) {
            lotteryHistory = [];
            
            data.forEach(row => {
                try {
                    // ניסיון לזהות עמודות באופן אוטומטי
                    const keys = Object.keys(row);
                    const dateKey = keys.find(k => k.includes('תאריך') || k.toLowerCase().includes('date'));
                    const strongKey = keys.find(k => k.includes('חזק') || k.toLowerCase().includes('strong'));
                    
                    // מציאת עמודות המספרים
                    const numberKeys = keys.filter(k => 
                        k.includes('מספר') || 
                        /^[1-6]$/.test(k) || 
                        k.toLowerCase().includes('number')
                    ).slice(0, 6);
                    
                    if (numberKeys.length >= 6 && strongKey) {
                        const numbers = numberKeys.map(k => parseInt(row[k])).filter(n => !isNaN(n) && n >= 1 && n <= 37);
                        const strong = parseInt(row[strongKey]);
                        
                        if (numbers.length === 6 && strong >= 1 && strong <= 8) {
                            lotteryHistory.push({
                                date: row[dateKey] || 'לא ידוע',
                                numbers: numbers,
                                strong: strong
                            });
                        }
                    }
                } catch (error) {
                    console.warn('Error processing row:', row, error);
                }
            });
            
            buildWinningCombinations();
            
            
        }

        // פונקציה להצגת פרסומת מסך מלא
        function showInterstitialAd() {
            try {
                const overlay = document.createElement('div');
                overlay.id = 'interstitial-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.9);
                    z-index: 10000;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    animation: fadeIn 0.3s ease-in-out;
                `;

                const adContainer = document.createElement('div');
                adContainer.style.cssText = `
                    background: white;
                    border-radius: 15px;
                    padding: 20px;
                    max-width: 90%;
                    max-height: 80%;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    position: relative;
                    animation: slideIn 0.3s ease-out;
                    text-align: center;
                `;

                adContainer.innerHTML = `
                    <h3 style="color: #333; margin-top: 0;">🎯 פרסומת</h3>
                    <div style="background: #f0f0f0; padding: 40px 20px; border-radius: 10px; margin: 20px 0;">
                        <p style="color: #666; font-size: 16px;">כאן תופיע הפרסומת שלך</p>
                        <p style="color: #999; font-size: 14px;">הוסף את קוד AdSense שלך</p>
                    </div>
                    <p style="color: #888; font-size: 12px;">הפרסומת תיסגר אוטומטית בעוד 5 שניות</p>
                `;

                const closeButton = document.createElement('button');
                closeButton.innerHTML = '✕';
                closeButton.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 15px;
                    background: #ff4757;
                    color: white;
                    border: none;
                    border-radius: 50%;
                    width: 35px;
                    height: 35px;
                    font-size: 18px;
                    cursor: pointer;
                    font-weight: bold;
                    transition: all 0.2s ease;
                    z-index: 10001;
                `;

                closeButton.onmouseover = () => {
                    closeButton.style.background = '#ff3838';
                    closeButton.style.transform = 'scale(1.1)';
                };

                closeButton.onmouseout = () => {
                    closeButton.style.background = '#ff4757';
                    closeButton.style.transform = 'scale(1)';
                };

                const closeAd = () => {
                    overlay.style.animation = 'fadeOut 0.3s ease-in-out';
                    setTimeout(() => {
                        if (overlay.parentNode) {
                            document.body.removeChild(overlay);
                        }
                    }, 300);
                };

                closeButton.onclick = closeAd;
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        closeAd();
                    }
                };

                adContainer.appendChild(closeButton);
                overlay.appendChild(adContainer);
                document.body.appendChild(overlay);

                setTimeout(() => {
                    if (document.getElementById('interstitial-overlay')) {
                        closeAd();
                    }
                }, 5000);

            } catch (error) {
                console.log('שגיאה בטעינת פרסומת:', error);
            }
        }

        // נתוני הסטטיסטיקות
        const regularStats = {
    1: 390, 2: 364, 3: 386, 4: 345, 5: 355, 6: 377, 7: 354, 8: 381,
    9: 359, 10: 381, 11: 409, 12: 394, 13: 361, 14: 338, 15: 355,
    16: 348, 17: 370, 18: 348, 19: 344, 20: 374, 21: 395, 22: 365,
    23: 359, 24: 368, 25: 391, 26: 385, 27: 375, 28: 381, 29: 386,
    30: 371, 31: 357, 32: 347, 33: 366, 34: 373, 35: 317, 36: 280, 37: 297
};

const strongStats = {
    1: 264, 2: 254, 3: 268, 4: 245, 5: 260, 6: 265, 7: 250, 8: 22
};
        
        // מספרים מסודרים לפי תדירות
        const hotRegular = Object.entries(regularStats)
            .sort((a, b) => b[1] - a[1])
            .map(([num]) => parseInt(num));
        
        const coldRegular = Object.entries(regularStats)
            .sort((a, b) => a[1] - b[1])
            .map(([num]) => parseInt(num));
        
        const hotStrong = Object.entries(strongStats)
            .sort((a, b) => b[1] - a[1])
            .map(([num]) => parseInt(num));
        
        const coldStrong = Object.entries(strongStats)
            .sort((a, b) => a[1] - b[1])
            .map(([num]) => parseInt(num));
        
        // פונקציה לעדכון תצוגת המספרים החמים בדף
        function updateHotNumbersDisplay() {
            const hotRegularList = document.getElementById('hot-regular-list');
            hotRegularList.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const num = hotRegular[i];
                const count = regularStats[num];
                const span = document.createElement('span');
                span.className = 'hot-number';
                span.textContent = `${num} (${count})`;
                hotRegularList.appendChild(span);
            }

            const hotStrongList = document.getElementById('hot-strong-list');
            hotStrongList.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const num = hotStrong[i];
                const count = strongStats[num];
                const span = document.createElement('span');
                span.className = 'hot-number';
                span.textContent = `${num} (${count})`;
                hotStrongList.appendChild(span);
            }
        }

        // עדכון תצוגת משקל
        document.getElementById('hotWeight').addEventListener('input', function() {
            document.getElementById('hotWeightValue').textContent = this.value + '%';
        });
        
        // פונקציה ליצירת צירוף זוכה מהיסטוריה (אם קיים)
        function generateWinningCombination() {
            if (lotteryHistory.length === 0) return null;
            
            const randomDraw = lotteryHistory[Math.floor(Math.random() * lotteryHistory.length)];
            return {
                numbers: [...randomDraw.numbers].sort((a, b) => a - b),
                strong: randomDraw.strong
            };
        }
        function selectUniqueNumbers(sourceArray, count) {
            if (count > sourceArray.length) {
                throw new Error(`Cannot select ${count} unique numbers from array of length ${sourceArray.length}`);
            }
            
            const shuffled = [...sourceArray].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, count);
        }
        
  async function generateNumbers() {
    showInterstitialAd();
       
    setTimeout(() => {
        const strategy = document.getElementById('strategy').value;
        const numCombinations = parseInt(document.getElementById('combinations').value);
        const hotWeight = parseInt(document.getElementById('hotWeight').value) / 100;
        const allowWinners = document.getElementById('allow-winners').checked;
        const allowNew = document.getElementById('allow-new').checked;
        
        const results = document.getElementById('results');
        results.innerHTML = '';

        results.innerHTML = '<div style="text-align: center; padding: 20px; font-size: 18px; color: #667eea;">🎲 יוצר את הצירופים שלך...</div>';

        setTimeout(() => {
            results.innerHTML = '';
            let generatedCount = 0;
            let attempts = 0;
            const maxAttempts = numCombinations * 10; // למנוע לולאה אינסופית

            while (generatedCount < numCombinations && attempts < maxAttempts) {
                attempts++;
                let regularNumbers, strongNumber, isWinner = false;

                // אם המשתמש רוצה רק צירופים זוכים ויש היסטוריה
                if (allowWinners && !allowNew && lotteryHistory.length > 0) {
                    const winningCombo = generateWinningCombination();
                    if (winningCombo) {
                        regularNumbers = winningCombo.numbers;
                        strongNumber = winningCombo.strong;
                        isWinner = true;
                    } else {
                        continue;
                    }
                } else {
                    // יצירת צירוף רגיל לפי האסטרטגיה
                    switch (strategy) {
                        case 'hot':
                            regularNumbers = generateHotNumbers(hotWeight);
                            strongNumber = generateHotStrongNumber(hotWeight);
                            break;
                        case 'balanced':
                            regularNumbers = generateBalancedNumbers();
                            strongNumber = generateBalancedStrongNumber();
                            break;
                        case 'cold':
                            regularNumbers = generateColdNumbers();
                            strongNumber = generateColdStrongNumber();
                            break;
                        default:
                            regularNumbers = generateRandomNumbers();
                            strongNumber = generateRandomStrongNumber();
                    }

                    isWinner = isCombinationWinner(regularNumbers, strongNumber);
                }

const noSequences = document.getElementById('no-sequences').checked;

// בדיקה על הצירוף
if (noSequences && hasSequenceOfThree(regularNumbers)) {
    continue; // דילוג על הצירוף הזה
}

const noTwoSequences = document.getElementById('no-two-sequences').checked;

if (noTwoSequences && hasSequenceOfTwo(regularNumbers)) {
    continue; // דילוג על הצירוף
}


                // בדיקה אם הצירוף מתאים להעדפות המשתמש
                const shouldInclude = (isWinner && allowWinners) || (!isWinner && allowNew);

                // אם לא הועלה קובץ היסטוריה, כל הצירופים נחשבים חדשים
                const hasHistory = lotteryHistory.length > 0;

                if (!hasHistory && allowNew) {
    displayCombination(regularNumbers, strongNumber, generatedCount + 1, false);

    try {
        await saveCombinationToFirebase({
            numbers: regularNumbers,
            strong: strongNumber,
            isWinner: false
        });
    } catch (error) {
        console.error("Error saving combination:", error);
    }

    generatedCount++;
} else if (hasHistory && shouldInclude) {
    displayCombination(regularNumbers, strongNumber, generatedCount + 1, isWinner);

    try {
        await saveCombinationToFirebase({
            numbers: regularNumbers,
            strong: strongNumber,
            isWinner: isWinner
        });
    } catch (error) {
        console.error("Error saving combination:", error);
    }

    generatedCount++;
}
}

            if (generatedCount === 0) {
                let errorMessage = '';
                const hasHistory = lotteryHistory.length > 0;

                if (!hasHistory && !allowNew) {
                    errorMessage = '⚠️ לא הועלה קובץ היסטוריה ולא נבחרה אפשרות "צירופים חדשים". אנא העלה קובץ Excel או אפשר צירופים חדשים.';
                } else if (hasHistory && !allowWinners && !allowNew) {
                    errorMessage = '⚠️ לא נבחרה אף אפשרות ליצירת צירופים. אנא בחר "צירופים שזכו בעבר" או "צירופים חדשים".';
                } else if (hasHistory && allowWinners && !allowNew) {
                    errorMessage = `⚠️ לא נמצאו מספיק צירופים זוכים במאגר ההיסטוריה (${winningCombinations.size} צירופים זוכים זמינים). נסה להוסיף גם צירופים חדשים.`;
                } else {
                    errorMessage = '⚠️ לא ניתן ליצור צירופים עם ההגדרות הנוכחיות. נסה לשנות את הפילטרים.';
                }

                results.innerHTML = `<div style="text-align: center; padding: 20px; font-size: 16px; color: #e17055; line-height: 1.5;">${errorMessage}</div>`;
            }
              else{
              incrementCombosInFirebase(generatedCount);
              }
        }, 800);
    }, 500);
          
}

        // פונקציות מתוקנות למניעת כפילויות
        function generateHotNumbers(weight) {
            const hotCount = Math.floor(6 * weight);
            const remainingCount = 6 - hotCount;
            
            let numbers = [];
            
            // בחירת מספרים חמים (מהטופ 15)
            if (hotCount > 0) {
                const hotPool = hotRegular.slice(0, Math.min(15, hotRegular.length));
                numbers.push(...selectUniqueNumbers(hotPool, Math.min(hotCount, hotPool.length)));
            }
            
            // השלמה עם מספרים אחרים
            if (remainingCount > 0) {
                const remainingPool = hotRegular.filter(num => !numbers.includes(num));
                numbers.push(...selectUniqueNumbers(remainingPool, Math.min(remainingCount, remainingPool.length)));
            }
            
            // אם עדיין חסרים מספרים (מקרה קיצוני)
            while (numbers.length < 6) {
                const allNumbers = Array.from({length: 37}, (_, i) => i + 1);
                const available = allNumbers.filter(num => !numbers.includes(num));
                if (available.length > 0) {
                    numbers.push(available[Math.floor(Math.random() * available.length)]);
                }
            }
            
            return numbers.sort((a, b) => a - b);
        }
        
        function generateHotStrongNumber(weight) {
            return Math.random() < weight 
                ? hotStrong[Math.floor(Math.random() * Math.min(3, hotStrong.length))]
                : hotStrong[Math.floor(Math.random() * hotStrong.length)];
        }
        
        function generateBalancedNumbers() {
            let numbers = [];
            
            // 3 מספרים חמים מהטופ 10
            const hotPool = hotRegular.slice(0, 10);
            numbers.push(...selectUniqueNumbers(hotPool, 3));
            
            // 2 מספרים בינוניים
            const mediumPool = hotRegular.slice(10, 27).filter(num => !numbers.includes(num));
            numbers.push(...selectUniqueNumbers(mediumPool, Math.min(2, mediumPool.length)));
            
            // 1 מספר קר
            const coldPool = hotRegular.slice(27).filter(num => !numbers.includes(num));
            if (coldPool.length > 0 && numbers.length < 6) {
                numbers.push(...selectUniqueNumbers(coldPool, Math.min(1, coldPool.length)));
            }
            
            // השלמה במידת הצורך
            while (numbers.length < 6) {
                const allNumbers = Array.from({length: 37}, (_, i) => i + 1);
                const available = allNumbers.filter(num => !numbers.includes(num));
                if (available.length > 0) {
                    numbers.push(available[Math.floor(Math.random() * available.length)]);
                }
            }
            
            return numbers.sort((a, b) => a - b);
        }
        
        function generateBalancedStrongNumber() {
            return hotStrong[Math.floor(Math.random() * hotStrong.length)];
        }
        
        function generateColdNumbers() {
            let numbers = [];
            
            // 4 מספרים קרים ביותר
            const coldPool = coldRegular.slice(0, 10);
            numbers.push(...selectUniqueNumbers(coldPool, Math.min(4, coldPool.length)));
            
            // 2 מספרים חמים לאיזון
            const hotPool = hotRegular.slice(0, 15).filter(num => !numbers.includes(num));
            numbers.push(...selectUniqueNumbers(hotPool, Math.min(2, hotPool.length)));
            
            // השלמה במידת הצורך
            while (numbers.length < 6) {
                const allNumbers = Array.from({length: 37}, (_, i) => i + 1);
                const available = allNumbers.filter(num => !numbers.includes(num));
                if (available.length > 0) {
                    numbers.push(available[Math.floor(Math.random() * available.length)]);
                }
            }
            
            return numbers.sort((a, b) => a - b);
        }
        
        function generateColdStrongNumber() {
            return coldStrong[Math.floor(Math.random() * Math.min(3, coldStrong.length))];
        }
        
        function generateRandomNumbers() {
            const allNumbers = Array.from({length: 37}, (_, i) => i + 1);
            return selectUniqueNumbers(allNumbers, 6).sort((a, b) => a - b);
        }
        
        function generateRandomStrongNumber() {
            return Math.floor(Math.random() * 8) + 1;
        }
        
        function displayCombination(regularNumbers, strongNumber, index, isWinner = false) {
            const results = document.getElementById('results');
            
            const combinationDiv = document.createElement('div');
            combinationDiv.className = isWinner ? 'combination winner' : 'combination new';
            
            const numbersDiv = document.createElement('div');
            numbersDiv.className = 'numbers';
            
            // תצוגת המספרים הרגילים
            regularNumbers.forEach(num => {
                const numberSpan = document.createElement('span');
                numberSpan.className = 'number regular';
                numberSpan.textContent = num;
                numbersDiv.appendChild(numberSpan);
            });
            
            // תצוגת המספר החזק
            const strongSpan = document.createElement('span');
            strongSpan.className = 'number strong';
            strongSpan.textContent = strongNumber;
            numbersDiv.appendChild(strongSpan);
            
            const infoDiv = document.createElement('div');
            const statusBadge = isWinner ? 
                '<span class="winner-badge">🏆 זכה בעבר</span>' : 
                '<span class="new-badge">🆕 צירוף חדש</span>';
            
            infoDiv.innerHTML = `
                ${statusBadge}
                <strong>צירוף מספר ${index}</strong><br>
                <small>מספר חזק: ${strongNumber}</small><br>
                <small style="color: #666;">✓ כל המספרים ייחודיים</small>
            `;
            
            combinationDiv.appendChild(numbersDiv);
            combinationDiv.appendChild(infoDiv);
            results.appendChild(combinationDiv);
        }
        

function hasSequenceOfThree(numbers) {
    const sorted = [...numbers].sort((a, b) => a - b);
    let count = 1;
    for (let i = 1; i < sorted.length; i++) {
        if (sorted[i] === sorted[i - 1] + 1) {
            count++;
            if (count >= 3) return true;
        } else {
            count = 1;
        }
    }
    return false;
}

function hasSequenceOfTwo(numbers) {
    const sorted = [...numbers].sort((a, b) => a - b);
    for (let i = 1; i < sorted.length; i++) {
        if (sorted[i] === sorted[i - 1] + 1) {
            return true; // נמצא זוג רציף
        }
    }
    return false;
}

     const excelUrl = "https://github.com/eliranneeman/loto_hot_number/raw/refs/heads/main/Lotto.xlsx";
    fetch(excelUrl)
    function loadExcelFromSite() {
    const status = document.getElementById('file-status');
    status.style.display = 'block';
    status.className = 'file-status';
    status.textContent = '🔄 טוען קובץ מהאתר...';

    // כאן יש להכניס את המיקום המדויק של הקובץ באתר
    const excelPath = 'Lotto.xlsx'; // אם הקובץ בתיקיית הראשית של האתר
    // אם בתיקייה אחרת, למשל 'assets/Lotto.xlsx', שנה ל- 'assets/Lotto.xlsx'

    fetch(excelPath)
        .then(res => {
            if (!res.ok) throw new Error('Failed to fetch Excel file');
            return res.arrayBuffer();
        })
        .then(ab => {
            const workbook = XLSX.read(ab, { type: "array" });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);

            // הפונקציה הקיימת שלך שמעבדת את הנתונים
            processLotteryData(jsonData);

            status.className = 'file-status success';
            status.textContent = `✅ הקובץ נטען בהצלחה! נטענו ${lotteryHistory.length} הגרלות`;

            // עדכון מונה היסטוריה
            document.getElementById('history-counter').textContent = lotteryHistory.length;
            document.getElementById('history-filter').style.display = 'flex';
        })
        .catch(error => {
            status.className = 'file-status error';
            status.textContent = '❌ שגיאה בטעינת הקובץ האוטומטי';
            console.error("Error loading Excel file:", error);
        });
}

//שמירת צירופים לפיירבייס
async function saveCombinationToFirebase(combination) {
    const docRef = await addDoc(collection(db, "combinations"), {
        combination,
        createdAt: new Date().toISOString(),
        hits: 0,
        hasStrong: false,
        expireAt: null
    });
    return docRef.id;
}

//חישוב פגיעות פלוס עידכון תאריך הפגיעה
async function processHits(lotteryHistory) {
    const q = query(collection(db, "combinations"));
    const snapshot = await getDocs(q);

    snapshot.forEach(async (docSnap) => {
        const c = docSnap.data();
        let maxHits = 0;
        let hasStrong = false;
        let lastExpireAt = null;

        lotteryHistory.forEach((draw, i) => {
            const drawDate = new Date(draw.תאריך);
            const drawNumbers = [draw.מספר1, draw.מספר2, draw.מספר3, draw.מספר4, draw.מספר5, draw.מספר6];
            const strong = draw.מספר_חזק;

            if (new Date(c.createdAt) <= drawDate) {
                const hits = c.combination.filter(num => drawNumbers.includes(num)).length;
                const strongHit = c.combination.includes(strong);

                if (hits >= 3) {
                    maxHits = Math.max(maxHits, hits);
                    hasStrong = strongHit;

                    let expireAt = null;

                    if ((hits === 3 || hits === 4) || (hits === 5 && !strongHit)) {
                        if (i < lotteryHistory.length - 1) {
                            expireAt = new Date(lotteryHistory[i + 1].תאריך);
                        }
                    }

                    if ((hits === 5 && strongHit) || hits === 6) {
                        expireAt = null; // לתמיד
                    }

                    lastExpireAt = expireAt;
                }
            }
        });

        // עדכון בפיירבייס
        await updateDoc(doc(db, "combinations", docSnap.id), {
            hits: maxHits,
            hasStrong,
            expireAt: lastExpireAt
        });
    });
}

//שליפה לחלונית הצד רק מה שלא פג תוקף
async function getActiveCombinations() {
    const q = query(collection(db, "combinations"));
    const snapshot = await getDocs(q);

    const now = new Date();
    const active = [];

    snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (!data.expireAt || new Date(data.expireAt) > now) {
            active.push({ id: docSnap.id, ...data });
        }
    });

    return active;
}


//תצוגה לחלונית הצד
async function renderSidebar() {
    const sidebarContent = document.getElementById("sidebar-content");
    sidebarContent.innerHTML = "<h3>📌 צירופים עם פגיעות</h3>";

    const combos = await getActiveCombinations();

    combos.forEach(r => {
        sidebarContent.innerHTML += `
            <div class="hit-combination">
              <strong>${r.combination.join(", ")}</strong>
              <span style="color:${r.hits >= 5 ? 'gold' : 'green'};">
                ✅ ${r.hits} פגיעות ${r.hasStrong ? '(כולל חזק)' : ''}
              </span>
              <div style="font-size:12px; color:#666;">
                נוצר ב: ${new Date(r.createdAt).toLocaleDateString()}  
                ${r.expireAt ? `(תקף עד ${new Date(r.expireAt).toLocaleDateString()})` : '(נשמר לתמיד)'}
              </div>
            </div>
        `;
    });
}


//פתיחת חלונית טעינת ההיסטוריה
function toggleUploadSection() {
    const section = document.getElementById("upload-section");
    section.style.display = section.style.display === "none" ? "block" : "none";
}

//בתיחת חלון צד
function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    sidebar.classList.toggle("open");
}


// אתחול האתר
document.addEventListener('DOMContentLoaded', function() {
    // טעינת מונים בזמן אמת
   // loadCounters();   // מאזין לשינויים בפיירבייס
    
    // העלאת מונה הביקורים ב-Firebase
   // incrementVisitInFirebase();
    
    loadExcelFromSite();
    updateHotNumbersDisplay();
    generateNumbers();
});
    </script>
</body>
</html>
